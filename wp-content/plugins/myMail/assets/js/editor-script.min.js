jQuery(document).ready(function(g){var l=g("body"),k,b,f,o,n;l.addClass("mymail-loading");g(window).on("load",function(){l.on("click","a",function(p){p.preventDefault()});d()});function m(){b=g("modules");f=b.find("module");o=g("img[editable]");n=g("buttons");j();c();h();l.removeClass("mymail-loading");return}function j(){if(b.data("sortable")){b.sortable("destroy")}if(n.data("sortable")){n.sortable("destroy")}n.sortable({stop:function(p,q){p.stopPropagation();b.removeClass("dragging");setTimeout(function(){d()},200)},start:function(p,q){p.stopPropagation();e();b.addClass("dragging")},containment:"parent",revert:100,placeholder:"sortable-placeholder",items:"> a",distance:5,forcePlaceholderSize:true,helper:"clone",zIndex:10000});if(f.length<2){return}b.sortable({stop:function(p,q){p.stopPropagation();b.removeClass("dragging");setTimeout(function(){d()},200)},start:function(p,q){p.stopPropagation();e();b.addClass("dragging")},containment:"body",revert:100,axis:"y",placeholder:"sortable-placeholder",items:"> module",delay:20,distance:5,scroll:true,scrollSensitivity:10,forcePlaceholderSize:true,helper:"clone",zIndex:10000})}function c(){if(o.data("draggable")){o.draggable("destroy")}if(o.data("droppable")){o.droppable("destroy")}o.draggable({helper:"clone",scroll:true,scrollSensitivity:10,opacity:0.7,zIndex:1000,revert:"invalid",addClasses:false,create:function(p,q){g(p.target).removeClass("ui-draggable-handle")},start:function(){l.addClass("ui-dragging")},stop:function(){l.removeClass("ui-dragging");d()}}).droppable({addClasses:false,over:function(p,q){g(p.target).addClass("ui-drag-over")},out:function(p,q){g(p.target).removeClass("ui-drag-over")},drop:function(r,s){var v=g(s.draggable[0]),t=g(r.target),p,q,u;t.removeClass("ui-drag-over");if(!v.is("img")||!t.is("img")){return}p=t.attr("data-id")?parseInt(t.attr("data-id"),10):null;q=v.attr("data-id")?parseInt(v.attr("data-id"),10):null;u=v.clone();v.addClass("mymail-loading");t.addClass("mymail-loading");a(v,function(w,x,y){a(t,function(A,B,z){if(r.altKey){v.removeClass("mymail-loading");t.removeClass("mymail-loading")}else{if(p){i("create_image",{id:p,width:w,_height:x},function(C){v.removeAttr("src").attr({"data-id":p,title:t.attr("title"),alt:t.attr("alt"),src:C.image.url,width:Math.round(C.image.width/y),height:Math.round(C.image.height/y)}).data("id",p).removeClass("mymail-loading")},function(C,E,D){alert(E+" "+C.status+": "+D+"\n\nCheck the JS console for more info!")})}else{v.removeAttr("src").attr({"data-id":0,title:t.attr("title"),alt:t.attr("alt"),src:t.attr("src"),width:Math.round(w/y),height:Math.round((w/(A/B))/y)}).data("id",0).removeClass("mymail-loading")}}if(q){i("create_image",{id:q,width:A,_height:B},function(C){t.removeAttr("src").attr({"data-id":q,title:v.attr("title"),alt:v.attr("alt"),src:C.image.url,width:Math.round(C.image.width/z),height:Math.round(C.image.height/z)}).data("id",q).removeClass("mymail-loading");d()},function(C,E,D){alert(E+" "+C.status+": "+D+"\n\nCheck the JS console for more info!")})}else{t.removeAttr("src").attr({"data-id":0,title:u.attr("title"),alt:u.attr("alt"),src:u.attr("src"),width:Math.round(A/z),height:Math.round((A/(w/x))/z)}).data("id",0).removeClass("mymail-loading")}if(!q&&!p){d()}})})}})}function h(){if(typeof mOxie!="undefined"){g.each(o,function(){var q=g(this),p;if(q.data("has-dropzone")){return}p=new mOxie.FileDrop({drop_zone:this});p.ondrop=function(x){if(parent.window.mymail_is_modulde_dragging){return}q.removeClass("ui-drag-over-file ui-drag-over-file-alt");var u=p.files.shift(),s=window.event&&event.altKey,v=[q.width(),q.height()],r=q.offset(),w=g('<div class="mymail-upload-info"><div class="mymail-upload-info-bar"></div><div class="mymail-upload-info-text"></div></div>').css({width:v[0],height:v[1],top:r.top,left:r.left}),t=new mOxie.Image(u);t.onerror=function(y){alert(mymailL10n.unsupported_format)};t.onload=function(y){w.appendTo("body");u._element=q;u._altKey=s;u._preview=w;u._dimensions=[t.width,t.height,t.width/t.height];t.downsize(v[0],v[1]);w.find(".mymail-upload-info-bar").css({"background-image":"url("+t.getAsDataURL()+")","background-size":v[0]+"px "+(v[0]/u._dimensions[2])+"px"});k.addFile(u)};t.load(u)};p.ondragenter=function(r){if(parent.window.mymail_is_modulde_dragging){return}q.addClass("ui-drag-over-file");if(window.event&&event.altKey){q.addClass("ui-drag-over-file-alt")}};p.ondragleave=function(r){if(parent.window.mymail_is_modulde_dragging){return}q.removeClass("ui-drag-over-file ui-drag-over-file-alt")};p.onerror=function(r){if(parent.window.mymail_is_modulde_dragging){return}q.removeClass("ui-drag-over-file ui-drag-over-file-alt")};p.init();q.data("has-dropzone",true)});if(!k){g('<button id="mymail-editorimage-upload-button" />').hide().appendTo("body");k=new plupload.Uploader(mymaildata.plupload);k.bind("Init",function(p){g(".moxie-shim").remove()});k.bind("FilesAdded",function(p,q){var r=q[0].getSource();a(r._element,function(u,s,t){p.settings.multipart_params.width=u;p.settings.multipart_params.height=s;p.settings.multipart_params.factor=t;p.settings.multipart_params.altKey=r._altKey;p.refresh();p.start()})});k.bind("BeforeUpload",function(p,q){});k.bind("UploadFile",function(p,q){});k.bind("UploadProgress",function(p,q){var r=q.getSource();r._preview.find(".mymail-upload-info-bar").width(q.percent+"%");r._preview.find(".mymail-upload-info-text").html(q.percent+"%")});k.bind("Error",function(p,q){var r=q.file.getSource();alert(q.message);r._preview.remove()});k.bind("FileUploaded",function(q,t,r){var v=t.getSource(),s,p;try{r=g.parseJSON(r.response);v._preview.find(".mymail-upload-info-text").html(mymailL10n.ready);v._element.on("load",function(){clearTimeout(s);v._preview.fadeOut(function(){g(this).remove();d()})});p=Math.round(v._element.width()/r.image.asp);v._element.attr({src:r.image.url,height:p,"data-id":r.image.id||0}).data("id",r.image.id||0);v._preview.height(p);s=setTimeout(function(){v._preview.fadeOut(function(){g(this).remove();d()})},3000)}catch(u){v._preview.addClass("error").find(".mymail-upload-info-text").html(mymailL10n.error);alert(mymailL10n.error_occurs+"\n"+u.message);v._preview.fadeOut(function(){g(this).remove()})}});k.bind("UploadComplete",function(p,q){});k.init()}}}window.mymail_refresh=function(){m()};window.mymail_onsave=function(){m()};function e(){if(parent.window.mymail_hideButtons){parent.window.mymail_hideButtons()}}function d(){if(parent.window.mymail_refresh){parent.window.mymail_refresh()}}function a(q,s){q=q.eq(0);if(q.is("img")&&q.attr("src")&&s){var r=new Image(),p;r.onload=function(){p=Math.max(1,Math.min(2,((r.width/(q.attr("width")||q.width())).toFixed(1)||1)));s.call(this,r.width,r.height,isFinite(p)?parseFloat(p):1)};r.src=q.attr("src")}}function i(s,r,t,q,p){if(g.isFunction(r)){if(g.isFunction(t)){q=t}t=r;r={}}g.ajax({type:"POST",url:window.mymaildata.ajaxurl,data:g.extend({action:"mymail_"+s,_wpnonce:window.mymaildata._wpnonce},r),success:function(v,w,u){t&&t.call(this,v,w,u)},error:function(u,w,v){if(w=="error"&&!v){return}if(console){console.error(g.trim(u.responseText))}q&&q.call(this,u,w,v)},dataType:p?p:"JSON"})}});